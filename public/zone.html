<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Zone de jeu</title>
  <link rel="stylesheet" href="css/zone.css" />
</head>
<body>
  <div id="top-bar">
    <div id="selecteur-fond" style="display: none;">
      <label for="fond-select">Changer de scène :</label>
      <select id="fond-select"></select>
    </div>
    <button id="btn-mj-page" style="display: none;">Page MJ</button>
    <button id="btn-fiche" style="display: none;">Fiche</button>
  </div>

  <div id="fond-image"></div>

  <!-- Zone dés fixée en bas -->
  <div class="zone-des" id="zone-des">
    <div id="liste-des"></div>

    <div id="controls-des">
      <select id="select-type-de">
        <option value="D4">D4</option>
        <option value="D6" selected>D6</option>
        <option value="D8">D8</option>
        <option value="D10">D10</option>
        <option value="D12">D12</option>
        <option value="D20">D20</option>
      </select>

      <select id="select-couleur-de">
        <option value="noir" selected>Noir</option>
        <option value="blanc">Blanc</option>
        <option value="rouge">Rouge</option>
      </select>

      <button id="btn-ajouter-de">Ajouter dé</button>
      <button id="btn-lancer-des">Lancer les dés</button>
      <button id="btn-supprimer-tout">Supprimer tout</button>
    </div>
  </div>

  <script src="js/zone.js"></script>

  <script>
    const role = localStorage.getItem("currentRole");

    if (role === "MJ") {
      document.getElementById("btn-mj-page").style.display = "inline-block";
      document.getElementById("selecteur-fond").style.display = "flex";
    }

    document.getElementById("btn-mj-page").addEventListener("click", () => {
      window.location.href = "mj.html";
    });

    document.getElementById("btn-fiche").addEventListener("click", () => {
      window.location.href = "fiche.html";
    });

    // ⚠️ Synchronisation fond pour MJ
    const fondSelect = document.getElementById("fond-select");
    if (role === "MJ") {
      const ws = new WebSocket(`wss://${window.location.host}`);

      ws.addEventListener("open", () => {
        ws.send(JSON.stringify({ type: "getImages" }));
      });

      ws.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "imagesList") {
          fondSelect.innerHTML = "";
          data.images.forEach((img, index) => {
            const opt = document.createElement("option");
            opt.value = img.url;
            opt.textContent = `${index + 1} - ${img.nom}`;
            fondSelect.appendChild(opt);
          });
        }
      });

      fondSelect.addEventListener("change", () => {
        const url = fondSelect.value;
        const msg = { type: "setFond", fondActif: url };
        ws.send(JSON.stringify(msg));
      });
    }
  </script>
</body>
</html>
